<!doctype html>
<html lang="ja">
<head>
<link rel="manifest" href="manifest.json">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ¯ãƒ¼ã‚¯ã‚¹ï½œç¤¾å†…ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    :root{
      --bg:#0b1020;
      --line:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.65);
      --chip:rgba(122,162,255,.12);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
              "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(122,162,255,.16), transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, rgba(255,180,130,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:14px;
      padding:14px;
    }

    .sidebar, .main{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    /* Sidebar */
    .sidebarHeader{
      padding:14px 14px 10px;
      background: rgba(0,0,0,.12);
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(145deg, rgba(122,162,255,.38), rgba(122,162,255,.10));
      border:1px solid rgba(122,162,255,.25);
      display:grid;place-items:center;
      font-weight:700;
      letter-spacing:.5px;
    }
    .title{display:flex;flex-direction:column;line-height:1.15;}
    .title .name{font-weight:750}
    .title .sub{font-size:12px;color:var(--muted)}
    .sidebarBody{
      padding:10px;
      height:calc(100% - 64px);
      overflow:auto;
    }
    .sectionLabel{
      font-size:12px;
      color:var(--muted);
      padding:10px 10px 6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
    }
    .addBtn{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(122,162,255,.30);
      background: rgba(122,162,255,.14);
      color: rgba(232,238,252,.95);
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
    }
    .addBtn:hover{background: rgba(122,162,255,.20)}

    .channel{
      width:100%;
      border:0;
      background: transparent;
      color:var(--text);
      text-align:left;
      padding:10px 10px;
      border-radius: 12px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .channel:hover{ background: rgba(255,255,255,.05); }
    .channel.active{
      background: rgba(122,162,255,.14);
      border:1px solid rgba(122,162,255,.20);
    }
    .channelLeft{ display:flex;align-items:center;gap:10px; min-width:0; }
    .hash{
      width:22px;height:22px;border-radius:8px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:grid;place-items:center;
      color:var(--muted);
      font-weight:700;
      flex:0 0 auto;
    }
    .channelName{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:650;
    }
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid rgba(122,162,255,.25);
      color: rgba(232,238,252,.9);
      flex:0 0 auto;
      white-space:nowrap;
    }

    /* Main layout: Slack-like (thread only when open) */
    .mainInner{
      height:100%;
      display:grid;
      grid-template-columns: 1fr; /* default: no thread, full width */
      gap:0;
    }
    .mainInner.threadOpen{
      grid-template-columns: 1fr 340px; /* thread open */
    }
    .chatPane{
      display:flex;
      flex-direction:column;
      min-width:0;
      border-right:1px solid var(--line);
    }
    .mainInner:not(.threadOpen) .chatPane{
      border-right:none;
    }
    .threadPane{
      display:none; /* hidden by default */
      flex-direction:column;
      min-width:0;
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(10,14,22,.92));
      border-left:1px solid rgba(255,255,255,.08);
      box-shadow: -18px 0 40px rgba(0,0,0,.25);
    }
    .mainInner.threadOpen .threadPane{
      display:flex;
    }

    .mainHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
      gap:12px;
    }
    .roomTitle{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .roomTitle .room{
      font-weight:800; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .roomTitle .desc{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toolbar{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      font-size:12px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.accent{
      border-color: rgba(122,162,255,.30);
      background: rgba(122,162,255,.14);
    }
    .btn.danger{
      border-color: rgba(255,120,120,.25);
      background: rgba(255,120,120,.10);
    }

    .messages, .threadMessages{
      flex:1;
      overflow:auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .msg{
      display:grid;
      grid-template-columns: 40px 1fr;
      gap:10px;
      align-items:flex-start;
    }
    .avatar{
      width:40px;height:40px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:grid;place-items:center;
      font-size:18px;
      user-select:none;
    }
    .bubble{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      position:relative;
    }
    .meta{ display:flex; align-items:baseline; gap:8px; margin-bottom:4px; flex-wrap:wrap; }
    .who{ font-weight:800; }
    .role{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
    }
    .time{ font-size:11px; color:var(--muted); }
    .text{ white-space:pre-wrap; line-height:1.45; }
    .sys{ display:flex; justify-content:center; margin:8px 0; }
    .sys span{
      font-size:12px;
      color:rgba(232,238,252,.7);
      border:1px dashed rgba(255,255,255,.18);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.10);
    }

    .bubbleActions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:6px;
      opacity:.95;
    }
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      color:var(--text);
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      cursor:pointer;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.08); }

    .threadHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .threadTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .threadTitle .t1{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .threadTitle .t2{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .threadParent{
      padding:14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }

    .composer{
      border-top:1px solid var(--line);
      padding:12px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(10,14,22,.92));
      border-left:1px solid rgba(255,255,255,.08);
      box-shadow: -18px 0 40px rgba(0,0,0,.25);
    }
    .field, .fieldSmall{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--text);
      padding:10px 10px;
      font-family:var(--font);
    }
    .fieldSmall{width:150px}
    .field{flex:1}
    .send{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(122,162,255,.30);
      background: rgba(122,162,255,.16);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .send:hover{background: rgba(122,162,255,.22)}

    
    .reactions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .reactPill{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      user-select:none;
    }
    .reactPill:hover{ background: rgba(255,255,255,.10); }
    .reactPill.active{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.16);
    }

    .reactPill{
      position:relative;
    }
    .reactPill:hover::after{
      content: attr(data-users);
      position:absolute;
      bottom:130%;
      left:50%;
      transform:translateX(-50%);
      background: rgba(0,0,0,.88);
      color: #fff;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 10px;
      white-space: nowrap;
      pointer-events:none;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      opacity: .98;
      z-index: 20;
    }


    @media (max-width: 980px){
      .mainInner.threadOpen{ grid-template-columns: 1fr; }
      /* ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãƒ¢ãƒã‚¤ãƒ«ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã™ã‚‹ãŸã‚ã€display:none ã‚’ä½¿ã‚ãªã„ */
      .mainInner.threadOpen .threadPane{ display:flex !important; }
    }
    @media (max-width: 880px){
      .app{grid-template-columns: 1fr}
      .sidebar{display:none}
    }
/* â–¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæ­»ã¬ç’°å¢ƒå‘ã‘ã®ä¿é™º */
.mainInner, .chatPane, .threadPane { min-height: 0 !important; }
.messages, .threadMessages { min-height: 0 !important; overflow-y: auto !important; }
.main { display:flex; } .mainInner { flex:1; }
/* ã‚¹ãƒ¬ãƒƒãƒ‰å´ï¼šå…¥åŠ›æ¬„ãŒç‹­ã„ã®ã§æŠ˜ã‚Šè¿”ã—ã¦ãƒœã‚¿ãƒ³ã‚’éš ã•ãªã„ */
#threadPane .composer { flex-wrap: wrap; }
#threadPane .fieldSmall { width: 120px; }
#threadPane .field { min-width: 180px; }
#threadPane .send { width: 100%; }

  
/* ã‚¹ã‚¿ãƒ³ãƒ—ãƒãƒ¼ */
.stampBar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  padding:8px 14px;
  border-top:1px solid var(--line);
  background: rgba(0,0,0,.04);
}
.stampBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  color:var(--text);
  border-radius: 999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.stampBtn:hover{ background: rgba(255,255,255,.08); }
.msgStamp .text{
  font-size: 28px;
  line-height: 1.1;
}


    /* ===== Mobile layout ===== */
    .backdrop{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      z-index:40;
    }

    @media (max-width: 900px){
      .app{
        grid-template-columns: 1fr;
        padding:10px;
      }
      .sidebar{
        display:block;
        position:fixed;
        top:0; bottom:0; left:-320px;
        width: 280px;
        max-width: 82vw;
        z-index:50;
        transition:left .18s ease;
        border-radius:0;
        margin:0;
      }
      .app.sidebarOpen .sidebar{ left:0; }
      .app.sidebarOpen .backdrop{ display:block; }

      /* Main takes full width */
      .main{ min-width:0; }

      /* Toolbar: wrap buttons */
      .toolbar{ flex-wrap:wrap; gap:8px; }
      #btnClear{ flex:1 1 100%; }

      /* Hide thread by default; show as overlay when open */
      .threadPane{
        position:fixed;
        top:10px; bottom:10px; right:-110%;
        width: min(520px, calc(100vw - 20px));
        z-index:60;
        transition:right .18s ease;
        border-radius: 18px;
        background: rgba(10, 14, 22, 0.98);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: 0 20px 60px rgba(0,0,0,.55);
        overflow: hidden;
      }
      .mainInner.threadOpen .threadPane{
        right:10px;
      }

      /* Make chat pane full width */
      .mainInner{
        grid-template-columns: 1fr;
      }
      .chatPane{ min-width:0; }

      /* Bubble actions wrap on small screens */
      .bubbleActions{ flex-wrap:wrap; gap:6px; }
      .bubbleActions .miniBtn{ padding:6px 10px; }

      /* Stamp bars wrap nicely */
      .stampBar{ gap:8px; }

      /* Composer fields stack */
      .composer{
        flex-wrap:wrap;
      }
      .composer .fieldSmall{ width: 45%; min-width: 140px; }
      .composer .field{ flex:1 1 100%; min-width: 200px; }
      .composer .send{ width: 100%; }
    }
/* ===== Mobile sidebar: make it opaque ===== */
@media (max-width: 900px){
  .sidebar{
    background: rgba(10, 14, 22, 0.96) !important; /* ã»ã¼ä¸é€æ˜ */
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-right: 1px solid rgba(255,255,255,.10);
    box-shadow: 18px 0 40px rgba(0,0,0,.45);
  }
}
/* --- Mobile: è¿”ä¿¡/å‰Šé™¤ãŒåå‰ã‚„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è¢«ã‚‹ã®ã‚’é˜²ã --- */
@media (max-width: 520px){
  .bubbleActions{
    position: static;          /* â† absoluteã‚„ã‚ã‚‹ */
    margin: 6px 0 6px;
    justify-content: flex-end; /* å³å¯„ã› */
    flex-wrap: wrap;          /* ç”»é¢ãŒç‹­ã„æ™‚ã¯æŠ˜ã‚Šè¿”ã™ */
    gap: 6px;
  }
  .bubbleActions .miniBtn{
    font-size: 10px;
    padding: 3px 7px;
  }
}
/* ===== Slacké¢¨ ãƒãƒ£ãƒ³ãƒãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */

.channelHeader{
  display:flex !important;
  flex-direction:column !important;
  align-items:flex-start !important;
  gap:12px;
}

.channelHeaderTop{
  display:flex;
  align-items:center;
  gap:10px;
}

.channelTitle{
  font-size:18px;
  font-weight:600;
}

.channelActions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
  
/* ===== App & Channel Menus (Slack-like) ===== */
.headerRight{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:8px;
}

.iconBtn{
  width:34px;
  height:34px;
  border-radius:10px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color: var(--text);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}
.iconBtn:hover{ background: rgba(255,255,255,.10); }

.menuOverlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.35);
  opacity:0;
  pointer-events:none;
  transition: opacity .15s ease;
  z-index: 2500;
}

.menuOverlay.open{
  opacity:1;
  pointer-events:auto;
}

.dropdownMenu{
  position:fixed;
  min-width: 220px;
  max-width: calc(100vw - 24px);
  background: rgba(10, 14, 22, 0.98);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 40px rgba(0,0,0,.55);
  border-radius: 14px;
  padding: 8px;
  z-index: 2600;
}

.dropdownTitle{
  font-size:12px;
  opacity:.75;
  padding: 8px 10px 6px;
}

.menuItem{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 10px;
  border-radius: 12px;
  border: 0;
  background: transparent;
  color: var(--text);
  cursor:pointer;
  text-align:left;
}
.menuItem:hover{ background: rgba(255,255,255,.08); }
.menuItem.danger{ color: #ffb4b4; }
.menuItem.danger:hover{ background: rgba(255,80,80,.14); }

.kbdHint{
  font-size:11px;
  opacity:.55;
}

@media (max-width: 520px){
  .dropdownMenu{ min-width: 200px; }
}


/* Sidebar header app button */
.sidebarTopRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.sidebarTopRow .sidebarTitle{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}


    .sidebarFooter{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .sidebarFooter .menuItem{
      flex:1 1 auto;
      justify-content:center;
    }

  
/* ===== Sidebar Footer Actions (always visible) ===== */
.sidebarFooterActions{
  position: sticky;
  bottom: 0;
  padding: 10px 12px 12px;
  margin-top: 10px;
  background: rgba(8,12,18,.92);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(255,255,255,.10);
  z-index: 5;
}
.sidebarFooterActions .footerGrid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.sidebarFooterActions .footerGrid .btn{
  width: 100%;
  justify-content: center;
}
.sidebarFooterActions .footerRow{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.sidebarFooterActions .footerRow .btn{
  flex:1;
  justify-content:center;
}

@media (max-width: 520px){
  /* Hide header action row on mobile; actions live in sidebar */
  .channelActions{ display:none !important; }
}


/* ===== Sidebar footer: FIXED so it never disappears ===== */
.sidebarFooterActions{
  position: absolute; /* default */
}
.sidebarDrawer{
  position: relative;
}
@media (max-width: 520px){
  .sidebarDrawer{
    position: fixed !important;
    top: 0;
    left: 0;
    height: 100dvh !important;
    width: min(86vw, 360px) !important;
    overflow: hidden !important;
    z-index: 40 !important;
  }
  .sidebarDrawer .sidebarInner{
    height: 100%;
    overflow-y: auto;
    padding-bottom: 140px; /* room for footer */
  }
  .sidebarDrawer .sidebarFooterActions{
    position: fixed !important;
    left: 0;
    bottom: 0;
    width: min(86vw, 360px) !important;
    z-index: 60 !important;
  }
}


/* more popover */
.morePopover{
  position: fixed;
  inset: 0;
  display: none;
  z-index: 9999;
  background: rgba(0,0,0,.28);
  backdrop-filter: blur(2px);
}
.morePopover.show{display:block;}
.morePopoverInner{
  position: absolute;
  min-width: 220px;
  max-width: calc(100vw - 24px);
  border-radius: 14px;
  padding: 10px;
  background: rgba(18,24,36,.92);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 50px rgba(0,0,0,.55);
}
.moreTitle{
  font-size: 12px;
  opacity: .75;
  margin: 2px 2px 8px;
}
.moreGrid{
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
}
.moreEmojiBtn{
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: inherit;
  font-size: 18px;
}
.moreEmojiBtn:active{transform: scale(.98);}
@media (max-width: 720px){
  .moreGrid{grid-template-columns: repeat(5, 1fr);}
  .moreEmojiBtn{width: 44px; height: 44px; font-size: 19px;}
}

</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebarHeader">
        <div class="brand">
          <div class="logo">ğŸ¦</div>
          <div class="title">
            <div class="name">æ ªå¼ä¼šç¤¾ãƒˆãƒªãƒ¯ãƒ¼ã‚¯ã‚¹</div>
            <div class="sub">ç¤¾å†…ãƒãƒ£ãƒƒãƒˆï¼ˆè‡ªå‹•ä¿å­˜ã‚ã‚Šï¼‰</div>
          </div>
        </div>
      </div>

      <div class="sidebarBody" id="channelList">
        <div class="sectionLabel">
          <span>ãƒãƒ£ãƒ³ãƒãƒ«</span>
          <span style="display:flex; gap:8px; align-items:center;">
            <button class="addBtn" id="btnAddChannel">ï¼‹ è¿½åŠ </button>
            <span class="pill" id="todayPill">ç¨¼åƒä¸­</span>
          </span>
        </div>
        <!-- channels injected -->
      </div>

      <div class="sidebarFooter">
        <div class="sidebarFooterActions">
          <button class="pillBtn" id="btnDeleteMode" title="å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">å‰Šé™¤: A</button>
          <button class="pillBtn" id="btnSound" title="é€šçŸ¥éŸ³åˆ‡æ›¿">é€šçŸ¥éŸ³: ON</button>
          <button class="pillBtn" id="btnExport" title="Export">Export</button>
          <button class="pillBtn danger" id="btnReset" title="ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </aside>

    <div class="backdrop" id="backdrop"></div>

    <main class="main">
      <div class="mainInner" id="mainInner">
        <!-- Chat -->
        <section class="chatPane">
          <div class="mainHeader">
            <button class="btn" id="btnMenu">â˜°</button>

            <div class="channelHeader">
              <div class="channelHeaderTop">
                <div class="roomTitle">
                  <div class="room" id="roomName"># å…¨ä½“é€£çµ¡</div>
                  <div class="desc" id="roomDesc">å…¨å“¡è¦‹ã¦ã€‚é³´ã„ã¦ã‚‚ã„ã„ã‘ã©çŸ­ãã€‚</div>
                </div>

                <div class="headerRight">
                  <button class="iconBtn" id="btnChannelMore" aria-label="channel menu">â€¦</button>
                </div>
              </div>

              <div class="channelActions"></div>
            </div>
          </div>

          <div class="messages" id="messages"></div>


          <div class="stampBar" id="stampBarMain">
            <button class="stampBtn" data-stamp="ğŸ‘">ğŸ‘</button>
            <button class="stampBtn" data-stamp="ğŸ¦â€â¬›">ğŸ¦â€â¬›</button>
            <button class="stampBtn" data-stamp="ğŸ£">ğŸ£</button>
            <button class="stampBtn" data-stamp="ğŸªµ">ğŸªµ</button>
            <button class="stampBtn" data-stamp="ğŸ’©">ğŸ’©</button>
            <button class="stampBtn" data-stamp="âœ¨">âœ¨</button>
          </div>

          <div class="composer">
            <input class="fieldSmall" id="who" list="whoList" value="ç¤¾é•·" />
            <input class="fieldSmall" id="role" value="äººé–“" />
            <input class="field" id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆEnterã§é€ä¿¡ï¼‰" />
            <button class="send" id="send">é€ä¿¡</button>
          </div>
        </section>

        <!-- Thread -->
        <aside class="threadPane" id="threadPane">
          <div class="threadHeader">
            <div class="threadTitle">
              <div class="t1" id="threadRoom">ã‚¹ãƒ¬ãƒƒãƒ‰</div>
              <div class="t2" id="threadHint">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿”ä¿¡ãŒã¤ãã‚„ã¤</div>
            </div>
            <button class="btn" id="btnCloseThread">é–‰ã˜ã‚‹</button>
          </div>

          <div class="threadParent" id="threadParent"></div>
          <div class="threadMessages" id="threadMessages"></div>


          <div class="stampBar" id="stampBarThread">
            <button class="stampBtn" data-stamp="ğŸ‘">ğŸ‘</button>
            <button class="stampBtn" data-stamp="ğŸ¦â€â¬›">ğŸ¦â€â¬›</button>
            <button class="stampBtn" data-stamp="ğŸ£">ğŸ£</button>
            <button class="stampBtn" data-stamp="ğŸ’©">ğŸ’©</button>
            <button class="stampBtn" data-stamp="âœ¨">âœ¨</button>
          </div>

          <div class="composer">
            <input class="fieldSmall" id="threadWho" list="whoList" value="ç¤¾é•·" />
            <input class="fieldSmall" id="threadRole" value="äººé–“" />
            <input class="field" id="threadText" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¿”ä¿¡ï¼ˆEnterã§é€ä¿¡ï¼‰" />
            <button class="send" id="threadSend">è¿”ä¿¡</button>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <datalist id="whoList"></datalist>


  <!-- Menus -->
  <div class="menuOverlay" id="menuOverlay"></div>

  <div class="dropdownMenu" id="channelMenu" style="display:none;">
    <div class="dropdownTitle">ãƒãƒ£ãƒ³ãƒãƒ«</div>
    <button class="menuItem danger" id="btnClear">ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ­ã‚°æ¶ˆå»</button></div><script>
  // ===== Storage =====
  const STORAGE_KEY = "toriworks_chat_saved_v2_stampsound";

  // ===== People (optional avatars) =====
  const people = {
    "ç¤¾é•·": { avatar: "ğŸ‘¨â€ğŸ’¼", role: "ç¤¾é•·" },
    "ã‚«ãƒ©ã‚¹": { avatar: "ğŸ¦â€â¬›", role: "çµ±æ‹¬/æƒ…å ±" },
    "ã‚­ãƒ„ãƒ„ã‚­": { avatar: "ğŸªµ", role: "åˆ¶ä½œ/å…¥åŠ›" },
    "ã‚³ã‚¶ã‚¯ãƒ©": { avatar: "ğŸ¦œ", role: "æ›¸é¡å‡¦ç†" },
    "ãƒãƒˆè»å›£": { avatar: "ğŸ•Šï¸", role: "ç¾å ´/ç¢ºä¿" },
    "ãƒ’ãƒ¨ã‚³": { avatar: "ğŸ£", role: "åŒè¡Œ/ç™’ã—" }
  };

  // ===== Helpers =====
  function nowTime(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${hh}:${mm}`;
  }
  
  // é€šçŸ¥éŸ³ï¼ˆãƒ”ãƒ¨ï¼‰
  function playNotify(){
    if(!state.soundEnabled) return;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      const o1 = ctx.createOscillator();
      const g1 = ctx.createGain();
      o1.type = "sine";
      o1.frequency.value = 880;
      g1.gain.value = 0.06;
      o1.connect(g1); g1.connect(ctx.destination);
      o1.start();
      o1.stop(ctx.currentTime + 0.06);

      const o2 = ctx.createOscillator();
      const g2 = ctx.createGain();
      o2.type = "sine";
      o2.frequency.value = 1320;
      g2.gain.value = 0.05;
      o2.connect(g2); g2.connect(ctx.destination);
      o2.start(ctx.currentTime + 0.07);
      o2.stop(ctx.currentTime + 0.14);

      setTimeout(() => ctx.close(), 200);
    }catch(e){
      // ignore
    }
  }

function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ===== Reactions (Slack-like) =====
  function normalizeReactions(obj){
    // store as {emoji: [who, who, ...]}
    if(!obj || typeof obj !== "object") return {};
    for(const k of Object.keys(obj)){
      if(!Array.isArray(obj[k])) obj[k] = [];
    }
    return obj;
  }

  function hasReacted(reactions, emoji, who){
    if(!reactions || !reactions[emoji]) return false;
    return reactions[emoji].includes(who);
  }

  function toggleReactionOnMessage(channelId, msgId, emoji, who){
    const list = state.logs[channelId] || [];
    const m = list.find(x => x.type === "msg" && x.id === msgId);
    if(!m) return;

    m.reactions = normalizeReactions(m.reactions);
    if(!m.reactions[emoji]) m.reactions[emoji] = [];

    const i = m.reactions[emoji].indexOf(who);
    if(i >= 0){
      m.reactions[emoji].splice(i, 1);
    }else{
      m.reactions[emoji].push(who);
    }

    // cleanup empty
    if(m.reactions[emoji].length === 0) delete m.reactions[emoji];
    if(Object.keys(m.reactions).length === 0) delete m.reactions;

    saveState();
    renderAll();
  }

  function toggleReactionOnReply(parentId, replyId, emoji, who){
    const arr = state.threads[parentId] || [];
    const r = arr.find(x => x.type === "msg" && x.id === replyId);
    if(!r) return;

    r.reactions = normalizeReactions(r.reactions);
    if(!r.reactions[emoji]) r.reactions[emoji] = [];

    const i = r.reactions[emoji].indexOf(who);
    if(i >= 0){
      r.reactions[emoji].splice(i, 1);
    }else{
      r.reactions[emoji].push(who);
    }

    if(r.reactions[emoji].length === 0) delete r.reactions[emoji];
    if(Object.keys(r.reactions).length === 0) delete r.reactions;

    saveState();
    renderAll();
  }

  function reactionsHTML(reactions, who){
    if(!reactions) return "";
    const entries = Object.entries(reactions);
    if(entries.length === 0) return "";
    return `<div class="reactions">` + entries.map(([e, arr]) => {
      const count = Array.isArray(arr) ? arr.length : 0;
      const active = Array.isArray(arr) && arr.includes(who) ? "active" : "";
      const users = Array.isArray(arr) ? arr : [];
      const usersLabel = users.length ? users.join(", ") : "â€”";
      return `<div class="reactPill ${active}" data-react-pill="${escapeHtml(e)}" data-users="${escapeHtml(usersLabel)}">${escapeHtml(e)} ${users.length}</div>`;
    }).join("") + `</div>`;
  }


  function makeId(){
    return "m_" + Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(2, 6);
  }
  function sys(text){
    return { type:"sys", time: nowTime(), text };
  }
  function msg(who, text, roleOverride=null, timeOverride=null){
    const p = people[who] || { avatar: "ğŸ‘¤", role: "â€”" };
    return {
      type: "msg",
      id: makeId(),
      who,
      avatar: p.avatar,
      role: roleOverride ?? p.role,
      time: timeOverride ?? nowTime(),
      text
    };
  }
  function uniqueIdFromName(name, existing){
    const base = name
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[^\p{L}\p{N}\-]/gu, "")
      .slice(0, 18) || "channel";
    let id = base;
    let n = 2;
    while(existing.some(c => c.id === id)){
      id = `${base}-${n++}`;
    }
    return id;
  }

  // ===== Defaults (first run) =====
  function defaultState(){
    const channels = [
      { id: "all", name: "å…¨ä½“é€£çµ¡", desc: "å…¨å“¡è¦‹ã¦ã€‚é³´ã„ã¦ã‚‚ã„ã„ã‘ã©çŸ­ãã€‚", badge: "é‡è¦" },
      { id: "ops", name: "å›åå ±å‘Š", desc: "è½ã¨ã—ç‰©ãƒ»å›åãƒ­ã‚°ã€‚å¤šã„æ™‚ã¯â€œå¤šã„â€ã ã‘ã§OKã€‚", badge: "ãƒ­ã‚°" },
      { id: "claim", name: "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ", desc: "å±‹å¤–é™å®šã€‚ä¸­ã«å…¥ã‚‹ãªã€‚å…¥ã‚‹ãªã€‚", badge: "è¦æ³¨æ„" },
      { id: "unpaid", name: "æœªæ‰•ã„ï¼ˆé³¥ç«‹ã¦ï¼‰", desc: "æœªå›åã¯ã“ã“ã€‚åœ§ã¯æ®µéšåˆ¶ã€‚ã‚„ã‚Šã™ãç¦æ­¢ã€‚", badge: "å›å" },
      { id: "random", name: "ã¬ãã‚Šã°é›‘è«‡", desc: "é›‘è«‡ç”¨ã€‚æ·±åˆ»ãªè©±ã¯ã—ãªã„ã€‚", badge: "ã‚†ã‚‹" },
      { id: "hanami", name: "èŠ±è¦‹_å ´æ‰€å–ã‚Š", desc: "èŠ±è¦‹ã®å ´æ‰€ç¢ºä¿ã€‚å®ˆã‚Œã‚Œã°å‹ã¡ã€‚", badge: "ç¾å ´" }
    ];

    const logs = {};
    channels.forEach(c => { logs[c.id] = [sys(`ï¼ˆ#${c.name}ï¼‰`)]; });

    logs.all = [
      sys("æœ¬æ—¥ã®ç¨¼åƒï¼š92% / çˆ†æ’ƒå¯¾å¿œï¼š3ä»¶ / è½ã¨ã—ç‰©å›åï¼š47ä»¶"),
      msg("ç¤¾é•·", "å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®ã€Œä¾é ¼_èŠ±è¦‹ã€è¦‹ã¨ã„ã¦ã€‚"),
      msg("ã‚«ãƒ©ã‚¹", "äº†è§£"),
      msg("ã‚­ãƒ„ãƒ„ã‚­", "è³‡æ–™ã¤ãã‚‹"),
      msg("ç¤¾é•·", "ç©´ã‚ã‘ãªã„ã§ã­"),
      msg("ã‚­ãƒ„ãƒ„ã‚­", "åŠªåŠ›ã™ã‚‹"),
    ];
    logs.ops = [
      sys("å›åãƒ­ã‚°ï¼šè‡ªå‹•é›†è¨ˆã¯ã—ã¦ãªã„ã€‚æ°—åˆ†ã§æ›¸ãã€‚"),
      msg("ã‚«ãƒ©ã‚¹", "æŒ‡è¼ª 9"),
      msg("ç¤¾é•·", "å¤šã„ãªï¼ï¼Ÿ"),
      msg("ã‚«ãƒ©ã‚¹", "å…¬åœ’ã«ã‚ã£ãŸ"),
      msg("ç¤¾é•·", "ä¾é ¼ä¸»ã®ã¯å…¥ã£ã¦ã‚‹ï¼Ÿ"),
      msg("ã‚«ãƒ©ã‚¹", "å…¥ã£ã¦ã‚‹"),
      msg("ç¤¾é•·", "ã‚ˆã—"),
      msg("ã‚«ãƒ©ã‚¹", "ã‚ã¨ã“ã‚Œæ‹¾ã£ãŸï¼ˆç§ç‰©ï¼‰"),
      msg("ç¤¾é•·", "100å††ã¯è¿”ã—ã¦"),
      msg("ã‚«ãƒ©ã‚¹", "ç„¡ç†"),
    ];
    logs.claim = [
      sys("æ³¨æ„ï¼šå±‹å†…å¯¾å¿œã¯ç¦æ­¢ï¼ˆé³¥ãŒè¿·å­ã«ãªã‚‹ï¼‰"),
      msg("ç¤¾é•·", "ç¾å ´ã©ã“ï¼Ÿ"),
      msg("ã‚«ãƒ©ã‚¹", "é§…å‰"),
      msg("ç¤¾é•·", "é³¥ã¯ï¼Ÿ"),
      msg("ãƒãƒˆè»å›£", "ã„ã‚‹"),
      msg("ç¤¾é•·", "â€¦â€¦åº§ã£ã¦ã‚‹ï¼Ÿ"),
      msg("ãƒãƒˆè»å›£", "åº§ã£ã¦ã‚‹"),
    ];
    logs.unpaid = [
      sys("é³¥ç«‹ã¦ï¼šåœ§ã¯æ®µéšåˆ¶ã€‚ã‚¹ãƒ†ãƒƒãƒ—1ï¼çª“ã‚³ãƒ³ã‚³ãƒ³ã€‚"),
      msg("ç¤¾é•·", "æœªæ‰•ã„ãƒªã‚¹ãƒˆæ›´æ–°ã—ãŸ"),
      msg("ã‚«ãƒ©ã‚¹", "è¦‹ãŸ"),
      msg("ç¤¾é•·", "ä»Šæ—¥è¡Œã‘ãã†ï¼Ÿ"),
      msg("ã‚«ãƒ©ã‚¹", "ã¾ããŒã‚“ã°ã‚Œã€œ"),
      msg("ç¤¾é•·", "ãã‚Œè¨€ã†ãª"),
    ];
    logs.random = [
      sys("é›‘è«‡ãƒãƒ£ãƒ³ãƒãƒ«ï¼šä»•äº‹ã®è©±ã¯ãªã‚‹ã¹ãã—ãªã„"),
      msg("ãƒ’ãƒ¨ã‚³", "ã¤ã„ã¦ã„ã£ãŸ"),
      msg("ãƒ’ãƒ¨ã‚³", "ãŸã®ã—ã„"),
      msg("ã‚³ã‚¶ã‚¯ãƒ©", "ç´™ãŠã„ã—ã„"),
      msg("ç¤¾é•·", "é£Ÿã¹ãªã„ã§"),
      msg("ã‚³ã‚¶ã‚¯ãƒ©", "ã‚€ã‚Š"),
    ];
    logs.hanami = [
      sys("æœ¬æ—¥ï¼šèŠ±è¦‹_å ´æ‰€å–ã‚Šã€‚ç¾å ´ã¯å…¬åœ’ã€‚å®ˆã‚Œã‚Œã°å‹ã¡ã€‚"),
      msg("ç¤¾é•·", "ä¾é ¼ï¼šâ—‹â—‹å…¬åœ’ 12:30é–‹å§‹ã€‚ãƒ–ãƒ«ãƒ¼ã‚·ãƒ¼ãƒˆç¢ºä¿ã€‚"),
      msg("ãƒãƒˆè»å›£", "äº†è§£"),
      msg("ã‚«ãƒ©ã‚¹", "ç¾å ´è¦‹ã¦ãã‚‹"),
      msg("ç¤¾é•·", "ç³ã¯æœ€çµ‚æ‰‹æ®µã§ã€‚"),
    ];

    return {
      version: 1,
      active: "hanami",
      channels,
      logs,
      threads: {},         // { [parentMsgId]: [replyMsg,...] }
      threadOpen: false,
      activeThreadId: null
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);

      // minimal validation / migrate
      if(!parsed || !parsed.channels || !parsed.logs) return defaultState();

      // Ensure required fields exist
      parsed.version ??= 1;
      parsed.threads ??= {};
      parsed.threadOpen ??= false;
      parsed.activeThreadId ??= null;

      // Ensure active channel exists
      if(!parsed.channels.some(c => c.id === parsed.active)){
        parsed.active = parsed.channels[0]?.id ?? "all";
      }
      // Ensure logs exist for channels
      parsed.channels.forEach(c => {
        if(!parsed.logs[c.id]) parsed.logs[c.id] = [sys(`ï¼ˆ#${c.name}ï¼‰`)];
      });

      return parsed;
    }catch{
      return defaultState();
    }
  }

  function saveState(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      alert("ä¿å­˜ã«å¤±æ•—ã—ãŸã‹ã‚‚ï¼ˆå®¹é‡/è¨­å®šï¼‰ï¼š" + e);
    }
  }

  // ===== State =====
  const state = loadState();
// å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ï¼šA=å®Œå…¨å‰Šé™¤ / B=å›åè¡¨ç¤ºï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰
state.deleteMode ??= "A"; // ä¿å­˜å¾©å…ƒã•ã‚Œã‚‹
// é€šçŸ¥éŸ³ï¼ˆä¿å­˜ï¼‰
state.soundEnabled ??= true;
saveState();

// ===== DOM =====
  const appEl = document.querySelector(".app");
  const backdropEl = document.getElementById("backdrop");
  const btnMenuEl = document.getElementById("btnMenu");
  const mainInnerEl = document.getElementById("mainInner");
  const channelListEl = document.getElementById("channelList");
  const messagesEl = document.getElementById("messages");
  const roomNameEl = document.getElementById("roomName");
  const roomDescEl = document.getElementById("roomDesc");

  const threadPaneEl = document.getElementById("threadPane");
  const threadParentEl = document.getElementById("threadParent");
  const threadMessagesEl = document.getElementById("threadMessages");
  const threadRoomEl = document.getElementById("threadRoom");

  const whoEl = document.getElementById("who");
  const roleEl = document.getElementById("role");
  const textEl = document.getElementById("text");

  const threadWhoEl = document.getElementById("threadWho");
  const threadRoleEl = document.getElementById("threadRole");
  const threadTextEl = document.getElementById("threadText");

  // Mobile: sidebar toggle
  if(btnMenuEl){
    btnMenuEl.addEventListener("click", () => {
      appEl.classList.toggle("sidebarOpen");
    });
  }
  if(backdropEl){
    backdropEl.addEventListener("click", () => {
      appEl.classList.remove("sidebarOpen");
    });
  }


  // Mobile: tap reaction counts to see who reacted (hoverä»£æ›¿)
  function tapShowReactUsers(e){
    const pill = e.target.closest(".reactPill");
    if(!pill) return;
    if(!window.matchMedia || !window.matchMedia("(max-width: 900px)").matches) return;
    const users = pill.getAttribute("data-users") || "";
    if(users) alert(users);
  }
  messagesEl.addEventListener("click", tapShowReactUsers);
  threadMessagesEl.addEventListener("click", tapShowReactUsers);

  // ===== UI logic =====
  function setThreadOpen(open){
    state.threadOpen = open;
    if(!open) state.activeThreadId = null;
    mainInnerEl.classList.toggle("threadOpen", open);
    saveState();
  }

  function renderChannels(){
    [...channelListEl.querySelectorAll(".channel")].forEach(n => n.remove());

    state.channels.forEach(ch => {
      const btn = document.createElement("button");
      btn.className = "channel" + (ch.id === state.active ? " active" : "");
      btn.type = "button";
      btn.innerHTML = `
        <div class="channelLeft">
          <div class="hash">#</div>
          <div class="channelName">${escapeHtml(ch.name)}</div>
        </div>
        <div class="badge">${escapeHtml(ch.badge)}</div>
      `;
      btn.addEventListener("click", () => {
        state.active = ch.id;
        setThreadOpen(false);
        renderAll();
        saveState();
        // mobile: close sidebar after selecting a channel
        appEl.classList.remove("sidebarOpen");
      });
      channelListEl.appendChild(btn);
    });
  }

  function renderHeader(){
    const ch = state.channels.find(c => c.id === state.active);
    roomNameEl.textContent = "# " + (ch?.name ?? "ä¸æ˜");
    roomDescEl.textContent = ch?.desc ?? "";
  }

  function countThreadReplies(parentId){
    return (state.threads[parentId]?.length ?? 0);
  }

  function renderMessages(){
    messagesEl.innerHTML = "";
    const list = state.logs[state.active] || [];
    list.forEach(item => {
      if(item.type === "sys"){
        const wrap = document.createElement("div");
        wrap.className = "sys";
        wrap.innerHTML = `<span>${escapeHtml(item.text)}</span>`;
        messagesEl.appendChild(wrap);
        return;
      }
      const replies = countThreadReplies(item.id);

      const row = document.createElement("div");
      row.className = "msg";
      row.innerHTML = `
        <div class="avatar" title="${escapeHtml(item.who)}">${escapeHtml(item.avatar)}</div>
        <div class="bubble ${item.isStamp ? "msgStamp" : ""}">
          <div class="bubbleActions">
  <button class="miniBtn" data-reply="${escapeHtml(item.id)}">è¿”ä¿¡${replies ? ` (${replies})` : ""}</button>
  <button class="miniBtn" data-del="${escapeHtml(item.id)}">å‰Šé™¤</button>
  <button class="miniBtn moreBtn" data-more="${escapeHtml(item.id)}" aria-label="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³">â€¦</button>
</div>

          <div class="meta">
            <div class="who">${escapeHtml(item.who)}</div>
            <div class="role">${escapeHtml(item.role)}</div>
            <div class="time">${escapeHtml(item.time)}</div>
          </div>
          <div class="text">${escapeHtml(item.text)}</div>
          ${reactionsHTML(item.reactions, whoEl.value.trim() || "ç¤¾é•·")}
        </div>
      `;
      row.querySelector(`[data-reply="${item.id}"]`).addEventListener("click", () => openThread(item.id));

      row.querySelector(`[data-del="${item.id}"]`).addEventListener("click", () => {
        const ok = confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ");
        if(!ok) return;
        deleteMessageById(state.active, item.id);
      });

      // reactions: open "â€¦" menu
      const moreBtn = row.querySelector(`[data-more="${item.id}"]`);
      if(moreBtn){
        moreBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          openMorePopover(moreBtn, item.id);
        });
      }
      row.querySelectorAll("[data-react-pill]").forEach(pill => {
        pill.addEventListener("click", () => {
          const who = whoEl.value.trim() || "ç¤¾é•·";
          toggleReactionOnMessage(state.active, item.id, pill.getAttribute("data-react-pill"), who);
        });
      });
      messagesEl.appendChild(row);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function renderAll(){
    renderChannels();
    renderHeader();
    renderMessages();

    // thread UI (if open)
    if(state.threadOpen && state.activeThreadId){
      mainInnerEl.classList.add("threadOpen");
      renderThreadPane();
    }else{
      mainInnerEl.classList.remove("threadOpen");
    }
  }

  // ===== More popover (reactions) =====
  const MORE_EMOJIS = ["ğŸ‘","ğŸ¦â€â¬›","ğŸ£","ğŸ’©","âœ¨","ğŸ˜‚","ğŸ™","ğŸ”¥","ğŸ‘€","â¤ï¸"];
  const morePopoverEl = document.getElementById("morePopover");
  const moreGridEl = document.getElementById("moreGrid");
  let moreForMsgId = null;

  function buildMoreGrid(){
    if(!moreGridEl) return;
    moreGridEl.innerHTML = MORE_EMOJIS.map(e => `
      <button class="moreEmojiBtn" data-more-emoji="${escapeHtml(e)}" title="${escapeHtml(e)}">${escapeHtml(e)}</button>
    `).join("");
    moreGridEl.querySelectorAll("[data-more-emoji]").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        ev.stopPropagation();
        if(!moreForMsgId) return;
        const who = whoEl.value.trim() || "ç¤¾é•·";
        const emoji = btn.getAttribute("data-more-emoji");
        toggleReactionOnMessage(state.active, moreForMsgId, emoji, who);
        closeMorePopover();
      });
    });
  }

  function openMorePopover(anchorEl, msgId){
    // Accept either (anchorEl, msgId) or (msgId, event/anchorEl)
    if(anchorEl && (typeof anchorEl === 'string' || typeof anchorEl === 'number')){
      const tmp = msgId;
      msgId = anchorEl;
      anchorEl = tmp;
    }
    if(anchorEl && anchorEl.currentTarget) anchorEl = anchorEl.currentTarget;
    if(!morePopoverEl) return;
    moreForMsgId = msgId;
    buildMoreGrid();
    morePopoverEl.classList.add("show");
    morePopoverEl.setAttribute("aria-hidden", "false");

    // position
    const inner = morePopoverEl.querySelector(".morePopoverInner");
    const r = anchorEl.getBoundingClientRect();
    const pad = 10;
    const maxLeft = window.innerWidth - (inner.offsetWidth || 240) - pad;
    let left = Math.min(maxLeft, Math.max(pad, r.left));
    let top = r.bottom + 10;
    // if near bottom, show above
    if(top + (inner.offsetHeight || 180) > window.innerHeight - pad){
      top = Math.max(pad, r.top - (inner.offsetHeight || 180) - 10);
    }
    inner.style.left = left + "px";
    inner.style.top = top + "px";
  }

  function closeMorePopover(){
    if(!morePopoverEl) return;
    morePopoverEl.classList.remove("show");
    morePopoverEl.setAttribute("aria-hidden", "true");
    moreForMsgId = null;
  }

  if(morePopoverEl){
    morePopoverEl.addEventListener("click", () => closeMorePopover());
    window.addEventListener("scroll", () => closeMorePopover(), {passive:true});
    window.addEventListener("resize", () => closeMorePopover(), {passive:true});
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeMorePopover();
    });
  }


  // ===== Thread =====
  function findMsgByIdInActiveChannel(msgId){
    const list = state.logs[state.active] || [];
    return list.find(m => m.type === "msg" && m.id === msgId) || null;
  }

  function renderThreadPane(){
    const parent = findMsgByIdInActiveChannel(state.activeThreadId);
    if(!parent){
      setThreadOpen(false);
      return;
    }

    const ch = state.channels.find(c => c.id === state.active);
    threadRoomEl.textContent = `# ${ch?.name ?? state.active} ã®ã‚¹ãƒ¬ãƒƒãƒ‰`;

    threadParentEl.innerHTML = `
      <div class="msg" style="grid-template-columns: 40px 1fr; gap:10px;">
        <div class="avatar">${escapeHtml(parent.avatar)}</div>
        <div class="bubble" style="margin:0;">
          <div class="meta">
            <div class="who">${escapeHtml(parent.who)}</div>
            <div class="role">${escapeHtml(parent.role)}</div>
            <div class="time">${escapeHtml(parent.time)}</div>
          </div>
          <div class="text">${escapeHtml(parent.text)}</div>
        </div>
      </div>
    `;

    renderThreadReplies();

    threadWhoEl.value = whoEl.value;
    threadRoleEl.value = roleEl.value;
  }

  function renderThreadReplies(){
    const parentId = state.activeThreadId;
    threadMessagesEl.innerHTML = "";

    const replies = state.threads[parentId] || [];
    if(replies.length === 0){
      const wrap = document.createElement("div");
      wrap.className = "sys";
      wrap.innerHTML = `<span>ï¼ˆè¿”ä¿¡ã¯ã¾ã ãªã„ï¼‰</span>`;
      threadMessagesEl.appendChild(wrap);
    }else{
      replies.forEach(r => {
        const row = document.createElement("div");
        row.className = "msg";
        row.innerHTML = `
  <div class="avatar">${escapeHtml(r.avatar)}</div>
  <div class="bubble ${r.isStamp ? "msgStamp" : ""}">
    <div class="bubbleActions">
      <button class="miniBtn" data-del-reply="${escapeHtml(r.id)}">å‰Šé™¤</button>
      <button class="miniBtn" data-react-reply="ğŸ‘" title="ğŸ‘">ğŸ‘</button>
      <button class="miniBtn" data-react-reply="ğŸ¦â€â¬›" title="ğŸ¦â€â¬›">ğŸ¦â€â¬›</button>
      <button class="miniBtn" data-react-reply="ğŸ’©" title="ğŸ’©">ğŸ’©</button>
      <button class="miniBtn" data-react-reply="âœ¨" title="âœ¨">âœ¨</button>
    </div>
    <div class="meta">
      <div class="who">${escapeHtml(r.who)}</div>
      <div class="role">${escapeHtml(r.role)}</div>
      <div class="time">${escapeHtml(r.time)}</div>
    </div>
    <div class="text">${escapeHtml(r.text)}</div>
    ${reactionsHTML(r.reactions, threadWhoEl.value.trim() || "ç¤¾é•·")}
  </div>
`;
row.querySelector(`[data-del-reply="${r.id}"]`).addEventListener("click", () => {
  const ok = confirm("ã“ã®è¿”ä¿¡ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ");
  if(!ok) return;
  deleteReplyById(state.activeThreadId, r.id);
});


row.querySelectorAll("[data-react-reply]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const who = (threadWhoEl.value.trim() || whoEl.value.trim() || "ç¤¾é•·");
    toggleReactionOnReply(state.activeThreadId, r.id, btn.getAttribute("data-react-reply"), who);
  });
});
row.querySelectorAll("[data-react-pill]").forEach(pill=>{
  pill.addEventListener("click", ()=>{
    const who = (threadWhoEl.value.trim() || whoEl.value.trim() || "ç¤¾é•·");
    toggleReactionOnReply(state.activeThreadId, r.id, pill.getAttribute("data-react-pill"), who);
  });
});


        threadMessagesEl.appendChild(row);
      });
    }
    threadMessagesEl.scrollTop = threadMessagesEl.scrollHeight;
  }

  function openThread(msgId){
    state.activeThreadId = msgId;
    setThreadOpen(true);
    renderAll();
    // focus
    setTimeout(() => threadTextEl.focus(), 0);
  }

  function closeThread(){
    setThreadOpen(false);
    renderAll();
  }

  function sendThreadReply(){
    if(!state.threadOpen || !state.activeThreadId) return;
    const who = threadWhoEl.value.trim() || "ç¤¾é•·";
    const role = threadRoleEl.value.trim() || "â€”";
    const text = threadTextEl.value.trim();
    if(!text) return;

    const p = people[who] || { avatar:"ğŸ‘¤", role };
    const reply = {
      type:"msg",
      id: makeId(),
      who,
      avatar: p.avatar,
      role,
      time: nowTime(),
      text
    };

    if(!state.threads[state.activeThreadId]) state.threads[state.activeThreadId] = [];
    state.threads[state.activeThreadId].push(reply);

    threadTextEl.value = "";
    saveState();
    renderThreadReplies();
    renderMessages(); // update reply count    playNotify();
  }

  // ===== Send message (channel) =====
  function send(){
    const who = whoEl.value.trim() || "ç¤¾é•·";
    const role = roleEl.value.trim() || "â€”";
    const text = textEl.value.trim();
    if(!text) return;

    const p = people[who] || { avatar:"ğŸ‘¤", role };
    const m = {
      type:"msg",
      id: makeId(),
      who,
      avatar: p.avatar,
      role,
      time: nowTime(),
      text
    };

    if(!state.logs[state.active]) state.logs[state.active] = [sys("ï¼ˆãƒ­ã‚°ï¼‰")];
    state.logs[state.active].push(m);

    textEl.value = "";
    saveState();
    renderMessages();    playNotify();
  }

  // ===== Export / Clear / Add channel / Reset =====
  async function exportActive(){
    const ch = state.channels.find(c => c.id === state.active);
    const lines = [];
    lines.push(`# ${ch?.name ?? state.active}`);
    lines.push(`â€” ${ch?.desc ?? ""}`);
    lines.push("");

    const list = state.logs[state.active] || [];
    for(const item of list){
      if(item.type === "sys"){
        lines.push(`[SYS] ${item.text}`);
      }else{
        lines.push(`[${item.time}] ${item.who} (${item.role}): ${item.text}`);
        const reps = state.threads[item.id] || [];
        if(reps.length){
          lines.push(`  â””â”€ replies:`);
          reps.forEach(r => lines.push(`     [${r.time}] ${r.who} (${r.role}): ${r.text}`));
        }
      }
    }
    const out = lines.join("\n");

    try{
      await navigator.clipboard.writeText(out);
      alert("ã‚³ãƒ”ãƒ¼ã—ãŸï¼ã©ã“ã«ã§ã‚‚è²¼ã‚Œã‚‹ã‚ˆã€‚");
    }catch{
      prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ã­ï¼ˆCtrl+Cï¼‰", out);
    }
  }

function clearActiveChannel(){
  const ch = state.channels.find(c => c.id === state.active);
  const ok = confirm(`#${ch?.name ?? state.active} ã®ãƒ­ã‚°ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å…¨éƒ¨æ¶ˆã™ï¼Ÿ`);
  if(!ok) return;

  // â‘  ä»Šã®ãƒãƒ£ãƒ³ãƒãƒ«ã®è¦ªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸IDã‚’å…¨éƒ¨å–å¾—
  const currentLogs = state.logs[state.active] || [];
  const parentIds = currentLogs
    .filter(m => m.type === "msg")
    .map(m => m.id);

  // â‘¡ ãã®è¦ªã«ç´ã¥ãã‚¹ãƒ¬ãƒƒãƒ‰ã‚‚å‰Šé™¤
  parentIds.forEach(id => {
    delete state.threads[id];
  });

  // â‘¢ ãƒ­ã‚°åˆæœŸåŒ–
  state.logs[state.active] = [sys("ï¼ˆãƒ­ã‚°ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æ¶ˆå»ã—ã¾ã—ãŸï¼‰")];

  closeThread();
  saveState();
  renderAll();
}

  function addChannel(){
    const name = prompt("ãƒãƒ£ãƒ³ãƒãƒ«åï¼ˆä¾‹ï¼šèŠ±è¦‹_å ´æ‰€å–ã‚Šï¼‰", "");
    if(!name) return;

    const desc = prompt("èª¬æ˜ï¼ˆçœç•¥OKï¼‰", "ï¼ˆæ–°è¦ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰") ?? "";
    const badge = prompt("ãƒãƒƒã‚¸ï¼ˆä¾‹ï¼šæ¡ˆä»¶ / é‡è¦ / ã‚†ã‚‹ï¼‰", "æ–°è¦") ?? "æ–°è¦";

    const id = uniqueIdFromName(name, state.channels);
    state.channels.push({ id, name, desc, badge });
    state.logs[id] = [sys(`ï¼ˆ#${name} ã‚’ä½œæˆã—ã¾ã—ãŸï¼‰`)];
    state.active = id;

    closeThread();
    saveState();
    renderAll();
  }

  function resetAll(){
    const ok = confirm("å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿï¼ˆãƒãƒ£ãƒ³ãƒãƒ«ãƒ»ãƒ­ã‚°ãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰å…¨éƒ¨æ¶ˆãˆã‚‹ï¼‰");
    if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    // reload as fresh
    location.reload();
  }

function deleteMessageById(channelId, msgId){
  const mode = state.deleteMode;

  // è¦ªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
  const list = state.logs[channelId] || [];
  const idx = list.findIndex(m => m.type === "msg" && m.id === msgId);
  if(idx === -1) return;

  if(mode === "A"){
    // A: å®Œå…¨å‰Šé™¤ï¼ˆè¦ªï¼‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚‚æ¶ˆã™ï¼‰
    list.splice(idx, 1);
    delete state.threads[msgId];

    // ä»Šè¦‹ã¦ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®è¦ªã‚’æ¶ˆã—ãŸã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰é–‰ã˜ã‚‹
    if(state.threadOpen && state.activeThreadId === msgId){
      setThreadOpen(false);
    }
  }else{
    // B: å›åè¡¨ç¤ºï¼ˆè¦ªã¯æ®‹ã™ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯æ®‹ã—ã¦ã‚‚OKã ã‘ã©è¦ªãŒå›åæ¸ˆã¿ã«ãªã‚‹ï¼‰
    const m = list[idx];
    m.deleted = true;
    m.deletedStyle = "crow";
    m.text = "ï¼ˆã“ã®ç™ºè¨€ã¯ã‚«ãƒ©ã‚¹ã«å›åã•ã‚Œã¾ã—ãŸï¼‰";
  }

  saveState();
  renderAll();
}

function deleteReplyById(parentId, replyId){
  const mode = state.deleteMode;
  const arr = state.threads[parentId] || [];
  const idx = arr.findIndex(r => r.id === replyId);
  if(idx === -1) return;

  if(mode === "A"){
    arr.splice(idx, 1);
  }else{
    arr[idx].deleted = true;
    arr[idx].deletedStyle = "crow";
    arr[idx].text = "ï¼ˆã“ã®è¿”ä¿¡ã¯ã‚«ãƒ©ã‚¹ã«å›åã•ã‚Œã¾ã—ãŸï¼‰";
  }

  saveState();
  renderAll();
}

  
  // ===== Stamps =====
  function sendStampToChannel(stamp){
    const who = whoEl.value.trim() || "ç¤¾é•·";
    const role = roleEl.value.trim() || "â€”";
    const p = people[who] || { avatar:"ğŸ‘¤", role };

    const m = {
      type:"msg",
      id: makeId(),
      who,
      avatar: p.avatar,
      role,
      time: nowTime(),
      text: stamp,
      isStamp: true
    };

    if(!state.logs[state.active]) state.logs[state.active] = [sys("ï¼ˆãƒ­ã‚°ï¼‰")];
    state.logs[state.active].push(m);

    saveState();
    renderMessages();
    playNotify();
  }

  function sendStampToThread(stamp){
    if(!state.threadOpen || !state.activeThreadId) return;

    const who = threadWhoEl.value.trim() || "ç¤¾é•·";
    const role = threadRoleEl.value.trim() || "â€”";
    const p = people[who] || { avatar:"ğŸ‘¤", role };

    const reply = {
      type:"msg",
      id: makeId(),
      who,
      avatar: p.avatar,
      role,
      time: nowTime(),
      text: stamp,
      isStamp: true
    };

    if(!state.threads[state.activeThreadId]) state.threads[state.activeThreadId] = [];
    state.threads[state.activeThreadId].push(reply);

    saveState();
    renderAll();
    playNotify();
  }

// ===== Wire events =====
  document.getElementById("send").addEventListener("click", send);
  textEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); send(); }
  });

  document.getElementById("btnExport").addEventListener("click", exportActive);
  document.getElementById("btnClear").addEventListener("click", clearActiveChannel);
  document.getElementById("btnAddChannel").addEventListener("click", addChannel);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  document.getElementById("btnCloseThread").addEventListener("click", closeThread);
  document.getElementById("threadSend").addEventListener("click", sendThreadReply);
  threadTextEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ e.preventDefault(); sendThreadReply(); }
  });

  // status pill
  (function(){
    const p = document.getElementById("todayPill");
    const d = new Date();
    p.textContent = `ç¨¼åƒä¸­ / ${d.getMonth()+1}/${d.getDate()}`;
  })();


  // name dropdown (datalist)
  (function(){
    const dl = document.getElementById("whoList");
    if(!dl) return;
    dl.innerHTML = "";
    const names = new Set(["ç¤¾é•·"]);
    Object.keys(people || {}).forEach(n => names.add(n));
    Array.from(names).forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      dl.appendChild(opt);
    });
  })();

  // ===== Init =====
  // reflect persisted thread state
  mainInnerEl.classList.toggle("threadOpen", !!state.threadOpen);
  renderAll();

function refreshSoundBtn(){
  const b = document.getElementById("btnSound");
  if(!b) return;
  b.textContent = `é€šçŸ¥éŸ³: ${state.soundEnabled ? "ON" : "OFF"}`;
}
document.getElementById("btnSound").addEventListener("click", () => {
  state.soundEnabled = !state.soundEnabled;
  saveState();
  refreshSoundBtn();
});
refreshSoundBtn();

// ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡
document.getElementById("stampBarMain").addEventListener("click", (e) => {
  const b = e.target.closest("[data-stamp]");
  if(!b) return;
  sendStampToChannel(b.getAttribute("data-stamp"));
});
document.getElementById("stampBarThread").addEventListener("click", (e) => {
  const b = e.target.closest("[data-stamp]");
  if(!b) return;
  sendStampToThread(b.getAttribute("data-stamp"));
});

function refreshDeleteModeBtn(){
  const b = document.getElementById("btnDeleteMode");
  if(!b) return;
  b.textContent = `å‰Šé™¤: ${state.deleteMode}`;
}
document.getElementById("btnDeleteMode").addEventListener("click", () => {
  state.deleteMode = (state.deleteMode === "A") ? "B" : "A";
  saveState();
  refreshDeleteModeBtn();
  alert(`å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã‚’ ${state.deleteMode} ã«ã—ãŸ`);
});
refreshDeleteModeBtn();

</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>


<script>
(function(){
  const moreBtn = document.getElementById('btnChannelMore');
  const menu = document.getElementById('channelMenu');
  const overlay = document.getElementById('menuOverlay');

  function hide(){
    if(menu) menu.style.display='none';
    if(overlay) overlay.style.display='none';
  }
  function show(anchor){
    if(!menu || !overlay || !anchor) return;
    overlay.style.display='block';
    menu.style.display='block';
    // position near anchor (top-right)
    const r = anchor.getBoundingClientRect();
    const mw = menu.offsetWidth || 220;
    const x = Math.max(12, Math.min(window.innerWidth - mw - 12, r.right - mw));
    const y = Math.max(12, r.bottom + 10);
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
  }

  if(moreBtn){
    moreBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const isOpen = menu && menu.style.display !== 'none' && menu.style.display !== '';
      if(isOpen) hide(); else show(moreBtn);
    });
  }
  if(overlay) overlay.addEventListener('click', hide);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });
  window.addEventListener('resize', hide);
})();
</script>


  <!-- Reaction quick menu -->
  <div id="morePopover" class="morePopover" aria-hidden="true">
    <div class="morePopoverInner">
      <div class="moreTitle">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
      <div class="moreGrid" id="moreGrid"></div>
    </div>
  </div>

</body>
</html>
